{% load static %}
<div class="container" style="max-width: 1000px; margin: 20px auto; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell;">
  <h2 style="margin:0 0 4px">CyberPanel .NET / SignalR</h2>
  <p class="muted" style="color:#666; margin:0 0 16px">Manage ASP.NET Core apps on OpenLiteSpeed via <code>cyberpanel-dotnet</code>. Enable/Deploy/Toggle and configure SignalR hubs.</p>

  <div style="display:grid; grid-template-columns: 1fr 1fr; gap:16px;">
    <section style="border:1px solid #eee; border-radius:8px; padding:14px;">
      <h3 style="margin:0 0 10px;">Enable (first time)</h3>
      <form id="fEnable" onsubmit="return false;">
        {% csrf_token %}
        <label>Domain</label>
        <input name="domain" placeholder="example.com" style="width:100%; padding:8px; margin:6px 0 10px">
        <label>Main DLL (entry point)</label>
        <input name="dll" placeholder="SimpleSignalR.dll" style="width:100%; padding:8px; margin:6px 0 10px">
        <button onclick="postJSON('enable','fEnable')" style="padding:8px 12px; border:0; background:#0a7; color:#fff; border-radius:6px">Enable</button>
      </form>
    </section>

    <section style="border:1px solid #eee; border-radius:8px; padding:14px;">
      <h3 style="margin:0 0 10px;">Deploy / Restart</h3>
      <form id="fDeploy" onsubmit="return false;">
        {% csrf_token %}
        <label>Domain</label>
        <input name="domain" placeholder="example.com" style="width:100%; padding:8px; margin:6px 0 10px">
        <label>Deploy from server path (optional)</label>
        <input name="fromdir" placeholder="/root/builds/SimpleSignalR" style="width:100%; padding:8px; margin:6px 0 10px">
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button onclick="postJSON('deploy','fDeploy')" style="padding:8px 12px; border:0; background:#0a7; color:#fff; border-radius:6px">Deploy</button>
          <button onclick="postJSON('restart','fDeploy')" style="padding:8px 12px; border:0; background:#555; color:#fff; border-radius:6px">Restart service</button>
        </div>
      </form>
      <div style="font-size:12px; color:#666; margin-top:8px;">Tip: <code>Deploy</code> restarts automatically. <code>Restart service</code> runs <code>systemctl restart dotnet-&lt;domain&gt;</code>.</div>
    </section>

    <section style="border:1px solid #eee; border-radius:8px; padding:14px;">
      <h3 style="margin:0 0 10px;">Toggle PHP / .NET</h3>
      <form id="fToggle" onsubmit="return false;">
        {% csrf_token %}
        <label>Domain</label>
        <input name="domain" placeholder="example.com" style="width:100%; padding:8px; margin:6px 0 10px">
        <label>Mode</label>
        <select name="mode" style="width:100%; padding:8px; margin:6px 0 10px">
          <option value="dotnet">dotnet</option>
          <option value="php">php</option>
        </select>
        <button onclick="postJSON('toggle','fToggle')" style="padding:8px 12px; border:0; background:#0a7; color:#fff; border-radius:6px">Apply</button>
      </form>
    </section>

    <section style="border:1px solid #eee; border-radius:8px; padding:14px;">
      <h3 style="margin:0 0 10px;">SignalR / WebSockets</h3>
      <form id="fSignalR" onsubmit="return false;">
        {% csrf_token %}
        <label>Domain</label>
        <input name="domain" placeholder="example.com" style="width:100%; padding:8px; margin:6px 0 10px">
        <div style="display:flex; gap:8px; align-items:center; margin:6px 0 10px;">
          <label>State</label>
          <select name="state" style="padding:8px;">
            <option value="on">on</option>
            <option value="off">off</option>
          </select>
        </div>
        <label>Hub paths (space separated)</label>
        <input name="hubs" placeholder="/hub /ConnectionHub /notifications" style="width:100%; padding:8px; margin:6px 0 10px">
        <button onclick="postJSON('signalr/toggle','fSignalR')" style="padding:8px 12px; border:0; background:#0a7; color:#fff; border-radius:6px">Apply</button>
      </form>
      <div style="font-size:12px; color:#666; margin-top:8px;">
        Paths must match your <code>Program.cs</code> mapping (e.g., <code>app.MapHub&lt;ChatHub&gt;("/hub")</code>).<br/>
        Note: Many OLS setups forward Upgrade headers by default; explicit contexts are useful if SignalR falls back to long polling or for multiple/custom hub paths.
      </div>
    </section>
  </div>

  <section style="border:1px solid #eee; border-radius:8px; padding:14px; margin-top:16px;">
    <h3 style="margin:0 0 10px;">Health & Debug</h3>
    <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
      <input id="d_domain" placeholder="example.com" style="padding:8px; min-width:260px">
      <a id="lnkH" target="_blank" style="padding:8px 12px; background:#116; color:#fff; border-radius:6px; text-decoration:none">Open /healthz</a>
      <a id="lnkD" target="_blank" style="padding:8px 12px; background:#116; color:#fff; border-radius:6px; text-decoration:none">Open /_debug</a>
    </div>
  </section>

  <pre id="output" style="background:#0b1020; color:#9fe; padding:12px; border-radius:8px; margin-top:15px; white-space:pre-wrap; word-break:break-all;"></pre>

  <section style="border:1px solid #eee; border-radius:8px; padding:14px; margin-top:16px;">
    <h3 style="margin:0 0 10px;">Quick Guide</h3>
    <pre style="background:#f7f7f9; padding:12px; border-radius:8px; overflow:auto;"><code>
# On your dev machine
dotnet publish -c Release -o publish

# Upload publish/* to your server
rsync -a --delete publish/ root@SERVER:/home/&lt;domain&gt;/public_html/NetCoreApp/

# Enable (first time)
sudo cyberpanel-dotnet enable &lt;domain&gt; --dll &lt;MainDll&gt;

# For subsequent updates, just restart
sudo systemctl restart dotnet-&lt;domain&gt;
# or
sudo cyberpanel-dotnet deploy &lt;domain&gt;

# Enable WebSocket header forwarding for default hub (/hub)
sudo cyberpanel-dotnet signalr YourAppDomain.com on

# Enable for a single custom hub
sudo cyberpanel-dotnet signalr YourAppDomain.com on /ConnectionHub

# Enable for multiple hubs
sudo cyberpanel-dotnet signalr YourAppDomain.com on /hub /ConnectionHub /notifications

# Disable it again (removes all SignalR contexts)
sudo cyberpanel-dotnet signalr YourAppDomain.com off
</code></pre>
  </section>

  <div style="margin-top:20px; font-size:13px; color:#666">
    <strong>Sudoers:</strong><br/>
    Allow the panel user to run the CLI and restart the per-site service without a password:<br/>
    <code>echo "lscpd ALL=(root) NOPASSWD: /usr/local/bin/cyberpanel-dotnet *" | sudo tee /etc/sudoers.d/kaypanel-dotnet</code><br/>
    <code>echo "lscpd ALL=(root) NOPASSWD: /usr/bin/systemctl restart dotnet-*" | sudo tee -a /etc/sudoers.d/kaypanel-dotnet</code><br/>
    Replace <code>lscpd</code> with your actual panel user if different.
  </div>

  <script>
    function setLinks() {
      const d = document.getElementById('d_domain').value.trim() || 'example.com';
      document.getElementById('lnkH').href = 'https://' + d + '/healthz';
      document.getElementById('lnkD').href = 'https://' + d + '/_debug';
    }
    document.getElementById('d_domain').addEventListener('input', setLinks);
    setLinks();

    async function postJSON(path, formId){
      const form = document.getElementById(formId);
      const data = new FormData(form);
      const r = await fetch(path, {
        method: 'POST',
        headers: {'X-Requested-With': 'fetch', 'X-CSRFToken': getCookie('csrftoken') || ''},
        body: data
      });
      const j = await r.json();
      document.getElementById('output').textContent = JSON.stringify(j, null, 2);
    }
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
  </script>
</div>
