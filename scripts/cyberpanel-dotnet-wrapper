#!/usr/bin/env bash
# Auto OLS wiring on `enable` (no prompt)
set -euo pipefail

REAL="/usr/local/bin/cyberpanel-dotnet-real"
PROXY_HELPER="/usr/local/bin/cyberpanel-dotnet-proxy"

require(){ command -v "$1" >/dev/null 2>&1 || { echo "missing: $1"; exit 1; }; }

auto_wire_ols() {
  local domain="$1"
  require "$REAL"
  require "$PROXY_HELPER"
  local port
  port="$(sudo "$REAL" port "$domain" | tr -d $'\r\n')" || true
  [[ -n "$port" ]] || { echo "[error] Could not determine Kestrel port for $domain"; exit 1; }
  sudo "$PROXY_HELPER" "$domain" "$port"
}

if [[ "${1:-}" == "enable" && $# -ge 4 ]]; then
  domain="$2"
  "$REAL" "$@"
  auto_wire_ols "$domain"
  exit 0
fi

exec "$REAL" "$@"
