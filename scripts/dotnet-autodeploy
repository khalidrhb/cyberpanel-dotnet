#!/usr/bin/env bash
set -Eeuo pipefail
shopt -s extglob

red(){ echo -e "\e[31m$*\e[0m"; }
grn(){ echo -e "\e[32m$*\e[0m"; }
yel(){ echo -e "\e[33m$*\e[0m"; }
err(){ red "[ERROR] $*" 1>&2; exit 1; }
info(){ echo "[i] $*"; }
sudo_ok(){ [[ ${EUID:-$(id -u)} -eq 0 ]] || err "Run as root (sudo)."; }
need(){ command -v "$1" >/dev/null 2>&1 || err "Missing dependency: $1 (please install it)"; }

# dotnet-autodeploy â€” one-shot scanner (invoked by systemd timer every ~30s)
ENV_DIR="/etc/dotnet-apps"
STATE_DIR="/etc/dotnet-autodeploy"
mkdir -p "$STATE_DIR"

sumfile(){ echo "$STATE_DIR/$(basename "$1").sum"; }

hash_file(){
  local f="$1"
  if [[ -f "$f" ]]; then sha1sum "$f" | awk '{print $1}'; else echo "missing"; fi
}

restart_service_for_env(){
  local envf="$1"
  local base; base=$(basename "$envf" .env)
  local unit="dotnet-app@${base}.service"
  systemctl restart "$unit" || true
}

for envf in "$ENV_DIR"/*.env; do
  [[ -f "$envf" ]] || continue
  # shellcheck disable=SC1090
  source "$envf" || true
  [[ -n "${DOCROOT:-}" ]] || continue

  if [[ -f "$DOCROOT/.redeploy" ]]; then
    restart_service_for_env "$envf"
    rm -f "$DOCROOT/.redeploy"
    continue
  fi

  s=$(sumfile "$envf")
  cur=$(hash_file "$DOCROOT/.dotnet")
  old=""; [[ -f "$s" ]] && old=$(cat "$s")
  if [[ "$cur" != "$old" ]]; then
    echo "$cur" > "$s"
    restart_service_for_env "$envf"
  fi
done
